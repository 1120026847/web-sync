<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Sync - å¤šç«¯åŒæ­¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .drag-over { border-color: #3b82f6 !important; background-color: #eff6ff; }
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-700 h-screen flex flex-col md:flex-row overflow-hidden">

    <div class="w-full md:w-1/2 h-1/2 md:h-full p-4 flex flex-col border-r border-gray-200 bg-white">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">ğŸ“ æ–‡æœ¬åŒæ­¥</h2>
            <div class="space-x-2">
                <button onclick="readTextClipboard()" class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded">è¯»å–å‰ªåˆ‡æ¿</button>
                <button onclick="copyText()" class="text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-1 rounded">å¤åˆ¶å…¨æ–‡</button>
                <span id="saveStatus" class="text-xs text-green-500 hidden">å·²ä¿å­˜</span>
            </div>
        </div>
        <textarea id="notepad" class="w-full flex-1 p-4 border border-gray-200 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 transition text-base font-mono" placeholder="åœ¨è¿™é‡Œè¾“å…¥æ–‡æœ¬ï¼Œå¤±å»ç„¦ç‚¹è‡ªåŠ¨ä¿å­˜..."></textarea>
    </div>

    <div class="w-full md:w-1/2 h-1/2 md:h-full p-4 flex flex-col bg-gray-50">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">ğŸ“‚ æ–‡ä»¶ä¼ è¾“</h2>
            <div class="space-x-2">
                 <button onclick="refreshFiles()" class="text-xs bg-white border hover:bg-gray-50 px-3 py-1 rounded shadow-sm">ğŸ”„ åˆ·æ–°</button>
                 <button onclick="uploadFromClipboard()" class="text-xs bg-indigo-50 text-indigo-600 hover:bg-indigo-100 px-3 py-1 rounded">ä¸Šä¼ å‰ªåˆ‡æ¿å›¾ç‰‡</button>
            </div>
        </div>

        <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer transition hover:border-blue-400 mb-4 relative">
            <p class="text-gray-500 pointer-events-none">æ‹–æ‹½æ–‡ä»¶ã€ç²˜è´´(Ctrl+V) æˆ– <span class="text-blue-500">ç‚¹å‡»ä¸Šä¼ </span></p>
            <input type="file" id="fileInput" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
        </div>

        <div class="flex-1 overflow-y-auto bg-white rounded-lg shadow-sm border border-gray-100">
            <ul id="fileList" class="divide-y divide-gray-100">
                </ul>
            <div id="loading" class="hidden p-4 flex justify-center"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6"></div></div>
        </div>
    </div>

    <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50" onclick="closePreview()">
        <div class="bg-white p-2 rounded max-w-3xl max-h-[90vh] overflow-auto relative">
             <img id="previewImage" src="" class="max-w-full h-auto block">
             <div id="previewUnknown" class="p-10 hidden text-center">æ— æ³•é¢„è§ˆæ­¤æ–‡ä»¶ç±»å‹</div>
        </div>
    </div>

<script>
    // === é…ç½® ===
    // éƒ¨ç½²åï¼Œå¦‚æœå‰ç«¯å’ŒWorkeråœ¨åŒä¸€åŸŸåä¸‹ï¼ˆæ¨èCloudflare Pages Functionsï¼‰ï¼Œä½¿ç”¨ç©ºå­—ç¬¦ä¸²
    // å¦‚æœåˆ†å¼€éƒ¨ç½²ï¼Œå¡«å†™ Worker çš„å®Œæ•´ URLï¼Œä¾‹å¦‚ https://api.yourdomain.com
    const API_BASE = '/api'; 

    // === 1. æ–‡æœ¬åŒæ­¥é€»è¾‘ ===
    const textarea = document.getElementById('notepad');
    const saveStatus = document.getElementById('saveStatus');

    // åŠ è½½æ–‡æœ¬
    async function loadText() {
        try {
            const res = await fetch(`${API_BASE}/text`);
            if(res.ok) textarea.value = await res.text();
        } catch(e) { console.error(e); }
    }

    // è‡ªåŠ¨ä¿å­˜
    textarea.addEventListener('blur', async () => {
        saveStatus.innerText = 'ä¿å­˜ä¸­...';
        saveStatus.classList.remove('hidden');
        try {
            await fetch(`${API_BASE}/text`, { method: 'POST', body: textarea.value });
            saveStatus.innerText = 'å·²ä¿å­˜';
            setTimeout(() => saveStatus.classList.add('hidden'), 2000);
        } catch(e) {
            saveStatus.innerText = 'ä¿å­˜å¤±è´¥';
            saveStatus.classList.add('text-red-500');
        }
    });

    function copyText() {
        textarea.select();
        document.execCommand('copy'); // å…¼å®¹æ€§æ›´å¥½
        alert('æ–‡æœ¬å·²å¤åˆ¶');
    }

    async function readTextClipboard() {
        try {
            const text = await navigator.clipboard.readText();
            textarea.value = text;
            textarea.dispatchEvent(new Event('blur')); // è§¦å‘ä¿å­˜
        } catch (err) {
            alert('æ— æ³•è¯»å–å‰ªåˆ‡æ¿ï¼Œè¯·å…è®¸æƒé™æˆ–åœ¨HTTPSä¸‹ä½¿ç”¨');
        }
    }

    // === 2. æ–‡ä»¶ä¸Šä¼ é€»è¾‘ ===
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    // æ‹–æ‹½æ•ˆæœ
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        handleFiles(e.dataTransfer.files);
    });

    // ç‚¹å‡»ä¸Šä¼ 
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    // ç²˜è´´ä¸Šä¼ 
    document.addEventListener('paste', (e) => {
        const items = e.clipboardData.items;
        const files = [];
        for (let i = 0; i < items.length; i++) {
            if (items[i].kind === 'file') {
                files.push(items[i].getAsFile());
            }
        }
        if (files.length > 0) handleFiles(files);
    });

    async function handleFiles(files) {
        if (!files.length) return;
        
        // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
        dropZone.innerHTML = `<p class="text-blue-500">æ­£åœ¨ä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶...</p>`;

        for (let file of files) {
            try {
                // 1. è·å–é¢„ç­¾å URL
                const signRes = await fetch(`${API_BASE}/sign-upload`, {
                    method: 'POST',
                    body: JSON.stringify({ filename: file.name, type: file.type })
                });
                const { url, key } = await signRes.json();

                // 2. ç›´ä¼  COS
                await fetch(url, {
                    method: 'PUT',
                    body: file,
                    headers: { 'Content-Type': file.type }
                });
            } catch (e) {
                console.error('Upload failed', e);
                alert(`æ–‡ä»¶ ${file.name} ä¸Šä¼ å¤±è´¥`);
            }
        }

        // æ¢å¤ UI å¹¶åˆ·æ–°
        dropZone.innerHTML = `<p class="text-gray-500 pointer-events-none">æ‹–æ‹½æ–‡ä»¶ã€ç²˜è´´(Ctrl+V) æˆ– <span class="text-blue-500">ç‚¹å‡»ä¸Šä¼ </span></p><input type="file" id="fileInput" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">`;
        refreshFiles();
    }
    
    async function uploadFromClipboard() {
        try {
            const items = await navigator.clipboard.read();
            const files = [];
            for (const item of items) {
                for (const type of item.types) {
                    if (type.startsWith('image/')) {
                        const blob = await item.getType(type);
                        files.push(new File([blob], `clipboard_${Date.now()}.png`, { type }));
                    }
                }
            }
            if (files.length > 0) {
                handleFiles(files);
            } else {
                alert("å‰ªåˆ‡æ¿ä¸­æ²¡æœ‰å›¾ç‰‡æ–‡ä»¶");
            }
        } catch (err) {
            alert("è¯»å–å‰ªåˆ‡æ¿å¤±è´¥ (éœ€è¦HTTPSä¸”è·å¾—æˆæƒ)");
        }
    }

    // === 3. æ–‡ä»¶åˆ—è¡¨ä¸ç®¡ç† ===
    const fileListEl = document.getElementById('fileList');
    const loadingEl = document.getElementById('loading');

    async function refreshFiles() {
        fileListEl.innerHTML = '';
        loadingEl.classList.remove('hidden');
        try {
            const res = await fetch(`${API_BASE}/files`);
            const files = await res.json();
            loadingEl.classList.add('hidden');
            
            files.forEach(file => {
                const li = document.createElement('li');
                li.className = 'p-3 hover:bg-gray-50 flex items-center justify-between group';
                
                // è®¡ç®—å¤§å°
                const sizeStr = (file.size / 1024).toFixed(1) + ' KB';
                const displayName = file.key.replace('uploads/', '').split('_').slice(1).join('_'); // å»æ‰å‰ç¼€å’Œæ—¶é—´æˆ³
                const isImg = /\.(jpg|jpeg|png|gif|webp)$/i.test(displayName);

                li.innerHTML = `
                    <div class="flex items-center overflow-hidden">
                        <div class="mr-3 text-2xl">${isImg ? 'ğŸ–¼ï¸' : 'ğŸ“„'}</div>
                        <div class="overflow-hidden">
                            <div class="font-medium text-sm truncate cursor-pointer text-gray-700 hover:text-blue-600" 
                                 onclick="preview('${file.url}', ${isImg})">${displayName}</div>
                            <div class="text-xs text-gray-400">${sizeStr} â€¢ ${new Date(file.date).toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="flex space-x-1 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
                        <a href="${file.url}" download class="p-1.5 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded" title="ä¸‹è½½">â¬‡ï¸</a>
                        <button onclick="copyFileLink('${file.url}')" class="p-1.5 text-gray-500 hover:text-green-600 hover:bg-green-50 rounded" title="å¤åˆ¶é“¾æ¥">ğŸ”—</button>
                        <button onclick="deleteFile('${file.key}')" class="p-1.5 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded" title="åˆ é™¤">ğŸ—‘ï¸</button>
                    </div>
                `;
                fileListEl.appendChild(li);
            });
        } catch(e) {
            loadingEl.classList.add('hidden');
            console.error(e);
        }
    }

    async function deleteFile(key) {
        if(!confirm('ç¡®å®šåˆ é™¤æ–‡ä»¶?')) return;
        await fetch(`${API_BASE}/delete`, { method: 'POST', body: JSON.stringify({ key }) });
        refreshFiles();
    }

    function copyFileLink(url) {
        navigator.clipboard.writeText(url).then(() => alert('æ–‡ä»¶é“¾æ¥å·²å¤åˆ¶'));
    }

    // === 4. é¢„è§ˆåŠŸèƒ½ ===
    window.preview = (url, isImg) => {
        const modal = document.getElementById('previewModal');
        const img = document.getElementById('previewImage');
        const unknown = document.getElementById('previewUnknown');
        
        modal.classList.remove('hidden');
        if(isImg) {
            img.src = url;
            img.classList.remove('hidden');
            unknown.classList.add('hidden');
        } else {
            img.classList.add('hidden');
            unknown.classList.remove('hidden');
            // è¿™é‡Œä¹Ÿå¯ä»¥é›†æˆ PDF.js æˆ–å…¶ä»–é¢„è§ˆåº“
        }
    }

    window.closePreview = () => {
        document.getElementById('previewModal').classList.add('hidden');
        document.getElementById('previewImage').src = '';
    }

    // åˆå§‹åŒ–
    loadText();
    refreshFiles();

</script>
</body>
</html>